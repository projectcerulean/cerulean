# Build manifest for sourcehut (https://builds.sr.ht/~gullik/cerulean)
image: archlinux

environment:
  GODOT_VERSION: 4.1.1
  GODOT_LINUX_64_ZIP_SHA512: 2c66d76227d9e3d76744db57cb9837a1a5472352f0725c3f1c78403342e78cb934a15ba3f448e9f43f2d83f4ed4f21e8901940900d5d39c6f84d9951a6ba6934

packages:
  - curl git kubo make unzip

sources:
  - https://git.sr.ht/~gullik/cerulean

tasks:
  - sync_assets: |
      cd cerulean
      ipfs daemon --init --init-profile server > /dev/null 2>&1 &
      timeout --verbose 1000 sh -c 'while ! ipfs swarm peers > /dev/null 2>&1; do sleep 1; done'
      git config --local include.path ../.gitconfig
      rm -rf assets
      timeout --verbose 1000 git reset --hard
      kill "$!"

  - download_godot: |
      timeout --verbose 1000 curl --silent --remote-name "https://downloads.tuxfamily.org/godotengine/${GODOT_VERSION}/Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
      echo "${GODOT_LINUX_64_ZIP_SHA512}  Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip" | sha512sum --check
      unzip "Godot_v${GODOT_VERSION}-stable_linux.x86_64.zip"
      [ -x "Godot_v${GODOT_VERSION}-stable_linux.x86_64" ]

  - set_version: |
      cd cerulean
      sed -i "s/const GIT_HASH: String = \"\"/const GIT_HASH: String = \"$(git rev-parse HEAD)\"/g" src/constants/version.gd

  - run_unit_tests: |
      cd cerulean
      timeout --verbose 1000 sh -c "make GODOT=../Godot_v${GODOT_VERSION}-stable_linux.x86_64 test"

  - export_game_pack: |
      cd cerulean
      timeout --verbose 1000 sh -c "make GODOT=../Godot_v${GODOT_VERSION}-stable_linux.x86_64 cerulean.pck"
      cd ..
      mv cerulean/cerulean.pck .
      sha512sum cerulean.pck | tee cerulean.pck.sha512

artifacts:
  - cerulean.pck
  - cerulean.pck.sha512
